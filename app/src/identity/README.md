# NoirHack App - SD-JWT Identity Credential Issuer (`identity` directory)

## Project Overview

This directory contains the core logic for the issuance of Selective Disclosure JWT Verifiable Credentials (SD-JWT VCs) representing a simple Identity Credential containing nationality information. It includes:

*   A service (`identityService.ts`) capable of issuing these credentials using statically configured issuer keys.
*   A test script (`testIssuance.ts`) to verify the issuance process outside the main application context.

Associated files outside this directory:
*   A one-time setup script (`../scripts/createIssuer.ts`) to generate the issuer's keys and DID document.
*   The configuration files (`../config/`) generated by the setup script.
*   Specific build configuration (`../tsconfig.build.json`) and npm scripts (`../package.json`) used to compile and run this identity logic directly with Node.js.

The setup is somewhat unconventional due to the need to run this TypeScript-based identity logic directly with Node.js for testing and setup, separate from the main Vite-based React application build process located in the parent directory.

## Setup (Relative to `noirhack/app/` directory)

1.  **Prerequisites:** Ensure you have Node.js (v18+) and npm installed.
2.  **Dependencies:** Navigate to the parent `noirhack/app` directory and run:
    ```bash
    npm install
    ```

## Issuer Configuration (One-Time Setup - Run from `noirhack/app/`)

The issuer's cryptographic keys and Decentralized Identifier (DID) document are generated and stored statically to avoid dynamic generation within the running service.

1.  **Clean Previous Builds (Optional but Recommended):**
    ```bash
    rm -rf ../config
    rm -rf ../dist
    ```
2.  **Build the Creation Script:** The setup script needs to be compiled from TypeScript to JavaScript:
    ```bash
    # This compiles scripts/createIssuer.ts -> dist/scripts/createIssuer.js
    # and src/identity/**/*.ts -> dist/src/identity/**/*.js
    # The copy part (`cp -r ../config ...`) will fail harmlessly here if config doesn't exist yet.
    npm run build:script 
    ```
3.  **Generate Configuration:** Run the compiled script to generate the keys and DID document:
    ```bash
    npm run create-issuer
    ```
    This command executes `node ../dist/scripts/createIssuer.js`. It performs the following actions:
    *   Generates an ES256 key pair using `jose`.
    *   Creates a `config` directory in the project root (`noirhack/app/config`).
    *   Saves the private key as a JWK in `config/issuer.private.jwk`.
    *   Creates a basic `did:web` DID document and saves it in `config/issuer.did.json`, embedding the public key JWK.

    You only need to run this **once**, or if you want to regenerate the issuer keys.

## Building the Identity Service & Scripts (Run from `noirhack/app/`)

This project uses a specific build process for the Node.js scripts related to identity:

```bash
npm run build:script
```
*   Uses `../tsconfig.build.json` to compile TypeScript files from `src/identity/` and `scripts/` into JavaScript (`.js` with `.js` imports for NodeNext compatibility) within the `../dist/` directory, preserving the relative directory structure (e.g., `src/identity/identityService.ts` -> `dist/src/identity/identityService.js`).
*   **Crucially, it also copies the `../config` directory (created by `npm run create-issuer`) into the `../dist` directory (`../dist/config`).** This makes the static configuration files available to the compiled JavaScript code when it runs.
*   This build is necessary for running the `create-issuer` and `start:test` scripts directly with Node.js.

*(Note: This is separate from the `npm run build` command which builds the main React application using Vite.)*

## Running the Test Script (Run from `noirhack/app/`)

Make sure you have run the **Issuer Configuration** and **Building** steps first.

1.  **Run the Test:**
    ```bash
    npm run start:test
    ```
2.  **Execution:**
    *   This executes `node ../dist/src/identity/testIssuance.js`.
    *   It imports `issueIdentityCredential` from the compiled `identityService.js`.
    *   It loads the static configuration from `../dist/config/`.
    *   It calls the issuance function and prints the resulting SD-JWT VC string to the console.

## Key Files in this Directory

*   `identityService.ts`: Contains the core logic for SD-JWT VC issuance, including loading static configuration.
*   `testIssuance.ts`: A simple script to trigger and test the `issueIdentityCredential` function directly via Node.js.
*   `README.md`: This file.

## Troubleshooting Notes (Specific to Identity Scripts)

*   **Path Sensitivity:** The scripts rely on correctly finding the `config` directory relative to their *compiled location* in `dist`. The `create-issuer` script creates `../config`, `build:script` copies it to `../dist/config`, and `identityService.js` (when run via `start:test`) looks for it in `../dist/config`. Errors like `ENOENT` usually indicate a missing file due to an incorrect path or a failed copy step. Ensure you run the clean/build/create/build sequence correctly from the `noirhack/app/` directory if encountering issues.
*   **Module Loading Hang:** Previously, issues were observed where running the test script would hang indefinitely. This seemed related to the module loading phase of the `@sd-jwt/sd-jwt-vc` library or its dependencies (`ajv`). The current separate build process (`build:script`) and direct Node execution (`start:test`) seems to avoid this specific hang. If the hang reappears, using `NODE_DEBUG=module npm run start:test` from the `noirhack/app/` directory might provide clues.
*   **Crypto Polyfill:** Both `createIssuer.ts` and `identityService.ts` include a polyfill for `globalThis.crypto` using `node:crypto.webcrypto`. This is necessary because the `jose` library expects a Web Crypto API compatible environment. 